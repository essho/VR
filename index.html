<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>VR Ultimate: Draw, Move & Create</title>
    
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    
    <script src="https://unpkg.com/super-hands/dist/super-hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@^4.0.0/dist/aframe-event-set-component.min.js"></script>
    
    <script src="https://unpkg.com/aframe-environment-component/dist/aframe-environment-component.min.js"></script>

</head>
<body>

    <a-scene physics="gravity: 0; debug: false" background="color: #ECECEC">

        <a-entity environment="preset: tron; grid: 1x1; groundColor: #222"></a-entity>

        <a-assets>
            <a-mixin id="grabbable" 
                     hoverable grabbable stretchable draggable droppable
                     dynamic-body="linearDamping: 0.5; angularDamping: 0.5; shape: auto"
                     shadow>
            </a-mixin>

            <a-mixin id="ink" 
                     geometry="primitive: sphere; radius: 0.04"
                     material="color: #ff0055; shader: flat"
                     hoverable grabbable stretchable draggable droppable
                     dynamic-body="linearDamping: 0.9; angularDamping: 0.9; shape: sphere">
            </a-mixin>
        </a-assets>

        <a-entity id="rig" movement-controls="fly: true; speed: 0.2" position="0 0 2">
            
            <a-entity camera position="0 1.6 0" look-controls></a-entity>

            <a-entity id="leftHand"
                      static-body="shape: sphere; sphereRadius: 0.02"
                      sphere-collider="objects: .grabbable, .ink-point; radius: 0.05"
                      super-hands="colliderEvent: collisions; colliderEventProperty: els; colliderEndEvent: collisions; colliderEndEventProperty: clearedEls"
                      hand-controls="hand: left; handModelStyle: lowPoly"
                      controller-listener-left> </a-entity>

            <a-entity id="rightHand"
                      static-body="shape: sphere; sphereRadius: 0.02"
                      sphere-collider="objects: .grabbable, .ink-point; radius: 0.05"
                      super-hands="colliderEvent: collisions; colliderEventProperty: els; colliderEndEvent: collisions; colliderEndEventProperty: clearedEls"
                      hand-controls="hand: right; handModelStyle: lowPoly"
                      drawing-brush controller-listener-right> </a-entity>

        </a-entity>

    </a-scene>

    <script>
        let createdShapes = [];
        let scene = document.querySelector('a-scene');

        // 1. دالة عامة لإنشاء الأشكال
        function spawnShape(type, position) {
            let el = document.createElement('a-entity');
            
            // إضافة الخصائص الفيزيائية والتفاعلية
            el.setAttribute('mixin', 'grabbable');
            
            // تحديد النوع واللون
            let color = '#' + Math.floor(Math.random()*16777215).toString(16);
            el.setAttribute('material', `color: ${color}`);

            if (type === 'box') {
                el.setAttribute('geometry', 'primitive: box; width: 0.5; height: 0.5; depth: 0.5');
            } else if (type === 'sphere') {
                el.setAttribute('geometry', 'primitive: sphere; radius: 0.3');
            } else if (type === 'cylinder') {
                el.setAttribute('geometry', 'primitive: cylinder; radius: 0.2; height: 0.6');
            }

            // وضعه أمام اليد بقليل
            // نأخذ موقع اليد ونضيف عليه مسافة بسيطة للأمام
            // للتبسيط هنا سنضعه في مكان اللاعب تقريباً
            let rigPos = document.querySelector('#rig').getAttribute('position');
            // حساب موقع تقريبي أمام اللاعب (هنا نستخدم موقع عشوائي بسيط قرب اللاعب)
            let x = rigPos.x + (Math.random() * 1 - 0.5);
            let y = 1.5; 
            let z = rigPos.z - 1;

            el.setAttribute('position', `${x} ${y} ${z}`);
            
            scene.appendChild(el);
            createdShapes.push(el);
        }

        function removeLastShape() {
            if (createdShapes.length > 0) {
                let last = createdShapes.pop();
                if(last.parentNode) last.parentNode.removeChild(last);
            }
        }

        // 2. مكون اليد اليمنى (A و B والرسم)
        AFRAME.registerComponent('controller-listener-right', {
            init: function () {
                // زر A -> يضيف مكعب
                this.el.addEventListener('abuttondown', function () {
                    spawnShape('box');
                });
                
                // زر B -> يضيف كرة
                this.el.addEventListener('bbuttondown', function () {
                    spawnShape('sphere');
                });
            }
        });

        // 3. مكون اليد اليسرى (X و Y)
        AFRAME.registerComponent('controller-listener-left', {
            init: function () {
                // زر X -> يضيف أسطوانة
                this.el.addEventListener('xbuttondown', function () {
                    spawnShape('cylinder');
                });
                
                // زر Y -> يحذف
                this.el.addEventListener('ybuttondown', function () {
                    removeLastShape();
                });
            }
        });

        // 4. مكون الرسم (معدل ليكون العنصر المرسوم قابلاً للمسك)
        AFRAME.registerComponent('drawing-brush', {
            init: function () {
                this.isDrawing = false;
                this.el.addEventListener('triggerdown', () => { this.isDrawing = true; });
                this.el.addEventListener('triggerup', () => { this.isDrawing = false; });
                this.throttle = 0; // للتحكم في سرعة الرسم
            },
            tick: function (t, dt) {
                if (this.isDrawing) {
                    this.throttle += dt;
                    // نرسم نقطة كل 25 ملي ثانية (لتحسين الأداء)
                    if (this.throttle > 25) {
                        this.throttle = 0;
                        let point = document.createElement('a-entity');
                        
                        // استخدام Mixin "ink" ليصبح قابلاً للمسك
                        point.setAttribute('mixin', 'ink');
                        
                        // نسخ موقع ودوران اليد
                        point.setAttribute('position', this.el.getAttribute('position'));
                        point.setAttribute('rotation', this.el.getAttribute('rotation'));
                        
                        // إضافة كلاس خاص للتعرف عليه
                        point.classList.add('ink-point');

                        this.el.sceneEl.appendChild(point);
                    }
                }
            }
        });
    </script>
</body>
</html>